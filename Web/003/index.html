<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一封情书</title>
    <link rel="icon" type="image/x-icon" href="https://i.loli.net/2021/06/03/lFg2V4WUcmkB98G.png">
    <meta name="language" content="zh-CN">
    <meta name="title" content="李欣谕">
    <meta name="github" content="https://github.com/sun0225SUN/Awesome-Love-Code">
    <meta name="description" content="收集不易，您的star是我坚持的动力，同时也欢迎各位PR哦! ">
    
    <!-- 替换为CDN资源，解决本地文件缺失问题 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jscex@3.0.5/build/jscex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jscex@3.0.5/build/jscex-parser.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jscex@3.0.5/build/jscex-jit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jscex@3.0.5/build/jscex-builderbase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jscex@3.0.5/build/jscex-async.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jscex@3.0.5/build/jscex-async-powerpack.min.js"></script>

    <!-- 内置原default.css核心样式，避免外部依赖 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: "Microsoft Yahei", "微软雅黑", Arial, sans-serif;
        }
        body {
            background-color: #ffe6e6;
            overflow: hidden;
        }
        #main {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #error {
            display: none;
            text-align: center;
            font-size: 18px;
            color: #e63946;
            padding: 20px;
            line-height: 1.8;
        }
        #error a {
            color: #d62828;
            text-decoration: none;
        }
        #wrap {
            position: relative;
            width: 1100px;
            height: 680px;
        }
        #text {
            position: absolute;
            top: 20px;
            left: 50px;
            z-index: 10;
            color: #333;
        }
        #code {
            font-size: 16px;
            line-height: 2;
            display: none;
        }
        .say {
            color: #d62828;
            font-weight: 500;
        }
        .space {
            margin-left: 2em;
        }
        #clock-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #6a040f;
            text-align: center;
            font-size: 16px;
        }
        #clock-box a {
            color: #9d0208;
            text-decoration: none;
        }
        #clock {
            font-size: 20px;
            font-weight: bold;
            margin-top: 5px;
        }
        #canvas {
            display: block;
            background-color: #fff;
        }
        .hand {
            cursor: pointer;
        }
        audio {
            display: none;
        }
    </style>
</head>

<body>
    <div id="main">
        <div id="error">亲，您使用的浏览器无法支持即将显示的内容，请换成谷歌(<a
                href="http://www.google.cn/chrome/intl/zh-CN/landing_chrome.html?hl=zh-CN&brand=CHMI">Chrome</a>)或者火狐(<a
                href="http://firefox.com.cn/download/">Firefox</a>)浏览器哟~</div>
        <div id="wrap">
            <div id="text">
                <div id="code">
                    <span class="say">亲爱的李欣谕：见字如面</span><br><br>
                    <span class="say">缘分真的很奇妙在认识你之前我都想过我的感情可能就这样了</span><br>
                    <span class="say">你问过我为什么喜欢你原谅我直到现在也不能给你一个好的答复</span><br>
                    <span class="say">虽然我不是什么聪明的人，但我应该能明白我喜欢你</span><br>
                    <span class="say">喜欢是什么喜欢是时间把所有的掩体都拿掉但我还是觉得你好可爱</span><br>
                    <br>
                    <span class="say">遇到你之后让我又对感情有了新的希望，我知道我一直等着的那个女孩子出现了</span><br>
                    <span class="say">我想跟你做很多的事情，一次吃饭一起旅游一起做很多的事情</span><br>
                    <span class="say">一起忘记过去的不愉快开始新的生活属于我们的新生活</span><br>
                    <br>
                    <span class="say">很开心在对的时间我们出现在彼此的生命里</span><br>
                    <span class="say">成为彼此重要的人不能离开也不想离开的人</span><br>
                    <span class="say">愿我们能享受炽热的新鲜感，也能经受住时间的打磨</span><br>
                    <span class="say">你总是焦虑但对我而言你不需要多完美做好你自己就好</span><br>
                    <span class="say">我喜欢你请你给我一个机会让我跟你在一起</span><br>
                    <br>
                    <span class="say"><span class="space"></span> -- 你的，太阳。</span>
                </div>
            </div>
            <div id="clock-box">
                星星 和 月亮 在一起的
                <div id="clock"></div>
            </div>
            <canvas id="canvas" width="1100" height="680"></canvas>
        </div>
    </div>

    <!-- 修复音频标签属性错误，替换为公共测试音频 -->
    <audio preload="auto" id="media" src="https://music.163.com/song/media/outer/url?id=186013.mp3" loop></audio>

    <script>
        // 补全原functions.js/love.js核心类和方法（解决外部依赖缺失）
        function Tree(canvas, width, height, opts) {
            this.ctx = canvas.getContext('2d');
            this.width = width;
            this.height = height;
            this.opts = opts || {};
            this.seed = new Seed(this.ctx, this.opts.seed);
            this.footer = new Footer(this.ctx, this.opts.footer);
            this.branchs = [];
            this.blooms = [];
            this._initBranchs(this.opts.branch);
        }

        Tree.prototype = {
            _initBranchs: function (branchs) {
                if (!branchs || !branchs.length) return;
                var self = this;
                branchs.forEach(function (b) {
                    self.branchs.push(new Branch(self.ctx, b));
                });
            },
            grow: function () {
                var growed = false;
                this.branchs.forEach(function (b) {
                    if (!b.dead) {
                        b.grow();
                        growed = true;
                    }
                });
                return growed;
            },
            canGrow: function () {
                for (var i = 0; i < this.branchs.length; i++) {
                    if (!this.branchs[i].dead) return true;
                }
                return false;
            },
            flower: function (num) {
                var bloomed = false;
                num = num || 1;
                for (var i = 0; i < num; i++) {
                    if (this.blooms.length < this.opts.bloom.num) {
                        var x = Math.random() * this.opts.bloom.width;
                        var y = Math.random() * this.opts.bloom.height;
                        this.blooms.push(new Bloom(this.ctx, x, y));
                        bloomed = true;
                    }
                }
                this.blooms.forEach(function (b, idx) {
                    if (b.dead) {
                        this.blooms.splice(idx, 1);
                        return;
                    }
                    b.draw();
                }.bind(this));
                return bloomed;
            },
            canFlower: function () {
                return this.blooms.length < this.opts.bloom.num;
            },
            snapshot: function (name, x, y, w, h) {
                this[name] = {
                    x: x,
                    y: y,
                    w: w,
                    h: h,
                    data: this.ctx.getImageData(x, y, w, h)
                };
            },
            move: function (name, dx) {
                if (!this[name]) return false;
                var p = this[name];
                if (p.x + dx > this.width) return false;
                p.x += dx;
                this.ctx.putImageData(p.data, p.x, p.y);
                return true;
            },
            jump: function () {
                this.blooms.forEach(function (b) {
                    b.jump();
                });
            },
            toDataURL: function (type) {
                return this.ctx.canvas.toDataURL(type || 'image/png');
            }
        };

        function Seed(ctx, opts) {
            this.ctx = ctx;
            this.x = opts.x || 0;
            this.y = opts.y || 0;
            this.color = opts.color || '#ff0000';
            this.scale = opts.scale || 1;
            this.maxScale = this.scale;
            this._active = true;
        }

        Seed.prototype = {
            draw: function () {
                if (!this._active) return;
                this.ctx.save();
                this.ctx.fillStyle = this.color;
                this.ctx.beginPath();
                this.ctx.arc(this.x, 680, this.scale, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();
            },
            hover: function (x, y) {
                var dx = x - this.x;
                var dy = y - 680;
                return Math.sqrt(dx * dx + dy * dy) < this.scale * 2;
            },
            canScale: function () {
                return this.scale > 0.2;
            },
            scale: function (ratio) {
                this.scale *= ratio;
                this.draw();
            },
            canMove: function () {
                return this.y > 300;
            },
            move: function (dx, dy) {
                this.y -= dy;
                this.draw();
            }
        };

        function Footer(ctx, opts) {
            this.ctx = ctx;
            this.width = opts.width || 0;
            this.height = opts.height || 0;
            this.speed = opts.speed || 1;
            this.x = 0;
        }

        Footer.prototype = {
            draw: function () {
                this.ctx.save();
                this.ctx.fillStyle = '#ffc0cb';
                this.ctx.fillRect(this.x, this.height - 5, this.width, this.height);
                this.ctx.restore();
                this.x += this.speed;
                if (this.x > this.width) this.x = 0;
            }
        };

        function Branch(ctx, opts) {
            this.ctx = ctx;
            this.p1 = {x: opts[0], y: opts[1]};
            this.p2 = {x: opts[2], y: opts[3]};
            this.p3 = {x: opts[4], y: opts[5]};
            this.width = opts[6] || 1;
            this.angle = opts[7] || 0;
            this.childs = [];
            this.dead = false;
            this._initChilds(opts[8]);
        }

        Branch.prototype = {
            _initChilds: function (childs) {
                if (!childs || !childs.length) return;
                var self = this;
                childs.forEach(function (c) {
                    self.childs.push(new Branch(self.ctx, c));
                });
            },
            grow: function () {
                if (this.width < 0.2) {
                    this.dead = true;
                    return;
                }
                this.ctx.save();
                this.ctx.beginPath();
                this.ctx.moveTo(this.p1.x, this.p1.y);
                this.ctx.quadraticCurveTo(this.p2.x, this.p2.y, this.p3.x, this.p3.y);
                this.ctx.lineWidth = this.width;
                this.ctx.strokeStyle = 'rgb(102, 51, 0)';
                this.ctx.stroke();
                this.ctx.restore();
                this.width *= 0.98;
                this.childs.forEach(function (c) {
                    if (!c.dead) c.grow();
                });
            }
        };

        function Bloom(ctx, x, y) {
            this.ctx = ctx;
            this.x = x;
            this.y = y;
            this.color = 'rgb(' + [
                190 + Math.random() * 20,
                26 + Math.random() * 20,
                37 + Math.random() * 20
            ].join(',') + ')';
            this.scale = Math.random() * 2 + 1;
            this.speed = {
                x: (Math.random() - 0.5) * 0.8,
                y: (Math.random() - 0.5) * 0.8
            };
            this.gravity = 0.02;
            this.dead = false;
        }

        Bloom.prototype = {
            draw: function () {
                if (this.dead) return;
                this.ctx.save();
                this.ctx.fillStyle = this.color;
                this.ctx.beginPath();
                this.ctx.arc(this.x, this.y, this.scale, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();
                this._update();
            },
            _update: function () {
                this.speed.y += this.gravity;
                this.x += this.speed.x;
                this.y += this.speed.y;
                this.scale *= 0.98;
                if (this.scale < 0.1 || this.y > 680) {
                    this.dead = true;
                }
            },
            jump: function () {
                this.speed.y = -Math.random() * 3 - 2;
                this.speed.x = (Math.random() - 0.5) * 2;
            }
        };

        // 补全原工具函数
        $.fn.typewriter = function () {
            var el = this;
            var text = el.html();
            el.html('');
            var i = 0;
            var timer = setInterval(function () {
                var char = text.charAt(i);
                if (char === '<') {
                    i = text.indexOf('>', i) + 1;
                } else {
                    i++;
                }
                el.html(text.substring(0, i));
                if (i >= text.length) clearInterval(timer);
            }, 60);
            return this;
        };

        function timeElapse(date) {
            var now = new Date();
            var diff = Math.floor((now - date) / 1000);
            var day = Math.floor(diff / 86400);
            diff -= day * 86400;
            var hour = Math.floor(diff / 3600);
            diff -= hour * 3600;
            var minute = Math.floor(diff / 60);
            diff -= minute * 60;
            var second = diff;
            $('#clock').html(day + '天' + hour + '小时' + minute + '分钟' + second + '秒');
        }

        // 主逻辑修复
        (function () {
            var canvas = $('#canvas');

            // 严谨的Canvas兼容性判断
            if (!canvas[0] || !canvas[0].getContext || !canvas[0].getContext('2d')) {
                $("#error").show();
                $("#wrap").hide();
                return false;
            }
            $("#error").hide(); // 默认隐藏错误提示

            var width = canvas.width();
            var height = canvas.height();
            canvas.attr({width: width, height: height});

            var opts = {
                seed: {
                    x: width / 2 - 20,
                    color: "rgb(190, 26, 37)",
                    scale: 2
                },
                branch: [
                    [535, 680, 570, 250, 500, 200, 30, 100, [
                        [540, 500, 455, 417, 340, 400, 13, 100, [
                            [450, 435, 434, 430, 394, 395, 2, 40]
                        ]],
                        [550, 445, 600, 356, 680, 345, 12, 100, [
                            [578, 400, 648, 409, 661, 426, 3, 80]
                        ]],
                        [539, 281, 537, 248, 534, 217, 3, 40],
                        [546, 397, 413, 247, 328, 244, 9, 80, [
                            [427, 286, 383, 253, 371, 205, 2, 40],
                            [498, 345, 435, 315, 395, 330, 4, 60]
                        ]],
                        [546, 357, 608, 252, 678, 221, 6, 100, [
                            [590, 293, 646, 277, 648, 271, 2, 80]
                        ]]
                    ]]
                ],
                bloom: {
                    num: 700,
                    width: 1080,
                    height: 650,
                },
                footer: {
                    width: 1200,
                    height: 5,
                    speed: 10,
                }
            };

            var tree = new Tree(canvas[0], width, height, opts);
            var seed = tree.seed;
            var foot = tree.footer;
            var hold = 1;

            // 修复事件绑定/解绑，添加音频播放触发（解决自动播放限制）
            canvas.click(function (e) {
                var offset = canvas.offset(), x = e.pageX - offset.left, y = e.pageY - offset.top;
                if (seed.hover(x, y)) {
                    hold = 0;
                    canvas.off("click mousemove").removeClass('hand');
                    
                    // 触发音频播放（解决现代浏览器自动播放策略）
                    document.getElementById('media').play().catch(function (err) {
                        // 播放失败时显示手动播放按钮
                        $('<button style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:12px 24px;background:#d62828;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;">点击播放音乐</button>')
                            .appendTo('#wrap')
                            .click(function () {
                                document.getElementById('media').play();
                                $(this).remove();
                            });
                    });
                }
            }).mousemove(function (e) {
                var offset = canvas.offset(), x = e.pageX - offset.left, y = e.pageY - offset.top;
                canvas.toggleClass('hand', seed.hover(x, y));
            });

            // 修复异步动画逻辑
            var seedAnimate = eval(Jscex.compile("async", function () {
                seed.draw();
                while (hold) {
                    $await(Jscex.Async.sleep(10));
                }
                while (seed.canScale()) {
                    seed.scale(0.95);
                    $await(Jscex.Async.sleep(10));
                }
                while (seed.canMove()) {
                    seed.move(0, 2);
                    foot.draw();
                    $await(Jscex.Async.sleep(10));
                }
            }));

            var growAnimate = eval(Jscex.compile("async", function () {
                do {
                    tree.grow();
                    $await(Jscex.Async.sleep(10));
                } while (tree.canGrow());
            }));

            var flowAnimate = eval(Jscex.compile("async", function () {
                do {
                    tree.flower(2);
                    $await(Jscex.Async.sleep(10));
                } while (tree.canFlower());
            }));

            var moveAnimate = eval(Jscex.compile("async", function () {
                tree.snapshot("p1", 240, 0, 610, 680);
                while (tree.move("p1", 500, 0)) {
                    foot.draw();
                    $await(Jscex.Async.sleep(10));
                }
                foot.draw();
                tree.snapshot("p2", 500, 0, 610, 680);

                // 修复背景闪烁问题
                setTimeout(function () {
                    canvas.parent().css("background", "url(" + tree.toDataURL('image/png') + ")");
                    canvas.css("background", "#ffc0cb");
                    setTimeout(function () {
                        canvas.css("background", "none");
                    }, 300);
                }, 0);
                $await(Jscex.Async.sleep(300));
            }));

            var jumpAnimate = eval(Jscex.compile("async", function () {
                var ctx = tree.ctx;
                while (true) {
                    ctx.clearRect(0, 0, width, height);
                    tree.jump();
                    foot.draw();
                    $await(Jscex.Async.sleep(25));
                }
            }));

            var textAnimate = eval(Jscex.compile("async", function () {
                // 修复时间计算（可自行修改为你们的纪念日，月份从0开始）
                var together = new Date(2001, 2, 25); // 2001年3月25日
                together.setHours(0, 0, 0, 0);

                $("#code").show().typewriter();
                $("#clock-box").fadeIn(500);
                while (true) {
                    timeElapse(together);
                    $await(Jscex.Async.sleep(1000));
                }
            }));

            var runAsync = eval(Jscex.compile("async", function () {
                $await(seedAnimate());
                $await(growAnimate());
                $await(flowAnimate());
                $await(moveAnimate());
                textAnimate().start();
                $await(jumpAnimate());
            }));

            runAsync().start();
        })();
    </script>
</body>
</html>
